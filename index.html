// 🔑 Add your Gemini API key here
const GEMINI_API_KEY = "YOUR_API_KEY_HERE"; // <-- replace with your real key

async function analyzeFrameWithAI(frameBase64) {
    if (!GEMINI_API_KEY) {
        console.error("❌ No Gemini API key set! Please add it to GEMINI_API_KEY.");
        return [];
    }

    try {
        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`,
            {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    contents: [
                        {
                            role: "user",
                            parts: [
                                {
                                    text: `You are an AI that detects baby hazards in a room image. 
                                        Look for things like sharp edges, choking hazards, exposed outlets, small objects, 
                                        unprotected stairs, cords, and other dangers. 
                                        Return ONLY a JSON array where each object has "hazard" (string) and "confidence" (0–1 number).`
                                },
                                {
                                    inlineData: {
                                        mimeType: "image/jpeg",
                                        data: frameBase64
                                    }
                                }
                            ]
                        }
                    ]
                })
            }
        );

        if (!response.ok) {
            console.error(`❌ Gemini API error: ${response.status} ${response.statusText}`);
            return [];
        }

        const result = await response.json();

        // Try to find AI's text output
        const aiText =
            result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

        if (!aiText) {
            console.warn("⚠️ No AI text output found.");
            return [];
        }

        // Ensure we have valid JSON
        let hazards = [];
        try {
            hazards = JSON.parse(aiText);
            if (!Array.isArray(hazards)) throw new Error("Not an array");
        } catch (err) {
            console.error("❌ Failed to parse AI output as JSON:", aiText);
            return [];
        }

        return hazards;
    } catch (error) {
        console.error("❌ Error in analyzeFrameWithAI:", error);
        return [];
    }
}
