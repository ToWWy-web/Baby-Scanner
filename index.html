<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Nursery Scout</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: #1a1a2e;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            color: white;
        }

        .app-container {
            width: 100%;
            height: 100vh;
            position: relative;
            display: none; /* Hidden until a room is selected */
            flex-direction: column;
        }
        
        /* --- Room Selection & Fullscreen Overlays --- */
        .fullscreen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a2e;
            z-index: 700;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            overflow-y: auto;
        }
        .overlay-content {
             width: 100%; max-width: 600px;
        }
        .overlay-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .overlay-header h2 { font-size: 28px; font-weight: 800; }
        .close-btn { font-size: 24px; background: none; border: none; color: white; cursor: pointer; }

        #roomSelectionScreen h2 { margin-bottom: 15px; }
        #roomSelectionScreen p { font-size: 16px; opacity: 0.8; margin-bottom: 40px; max-width: 300px; margin-left: auto; margin-right: auto;}
        .room-options { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .room-btn { background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 20px; color: white; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; font-family: 'Nunito', sans-serif; }
        .room-btn:hover { background: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.4); transform: translateY(-5px); }
        .room-btn span { display: block; font-size: 32px; }

        .header {
            position: absolute; top: 0; left: 0; right: 0;
            background: linear-gradient(to bottom, rgba(26, 26, 46, 0.8), transparent);
            padding: 20px 20px 40px 20px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title { text-align: left; }
        .header h1 { font-size: 22px; font-weight: 800; margin-bottom: 2px; }
        .header p { opacity: 0.9; font-size: 13px; }
        .safety-score-container { background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 20px; text-align: center; }
        .safety-score-label { font-size: 12px; font-weight: 600; opacity: 0.8; }
        .safety-score { font-size: 24px; font-weight: 800; color: #a0e7e5; }

        .camera-container { position: relative; width: 100%; height: 100vh; background: #000; overflow: hidden; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        .camera-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }

        .hazard-polygon { stroke-width: 5px; stroke-linejoin: round; fill: none; pointer-events: auto; cursor: pointer; animation: hazardPulse 1.5s ease-in-out infinite; }
        @keyframes hazardPulse { 0%, 100% { filter: drop-shadow(0 0 5px currentColor) drop-shadow(0 0 10px currentColor); opacity: 0.8; } 50% { filter: drop-shadow(0 0 10px currentColor) drop-shadow(0 0 20px currentColor); opacity: 1; } }

        .controls { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(26, 26, 46, 0.9), transparent); padding: 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); z-index: 100; display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        .control-btn { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: none; border-radius: 25px; padding: 14px 22px; color: white; font-size: 14px; font-weight: 700; font-family: 'Nunito', sans-serif; cursor: pointer; transition: all 0.3s ease; min-width: 80px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .control-btn:hover, .control-btn:active { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; background: rgba(100,100,100,0.2); transform: none; box-shadow: none; }
        .control-btn.active { background: #82aaff; box-shadow: 0 0 20px rgba(130, 170, 255, 0.5); }
        .control-btn.danger { background: #ff7e67; }
        .control-btn.secondary { background: rgba(130, 170, 255, 0.2); }

        .status-indicator, .toast-notification, .tip-banner { position: absolute; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; z-index: 800; display: none; transition: opacity 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .status-indicator { top: 100px; }
        .tip-banner { top: 150px; background: rgba(130, 170, 255, 0.2); cursor: pointer; }

        .camera-error { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center; background: rgba(40, 40, 60, 0.9); padding: 30px; border-radius: 20px; z-index: 200; width: calc(100% - 40px); max-width: 400px; }
        .hazard-list-container { position: absolute; bottom: 130px; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 500px; background: rgba(26, 26, 46, 0.7); backdrop-filter: blur(8px); border-radius: 15px; padding: 10px; z-index: 99; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; border: 1px solid rgba(255,255,255,0.1); }
        .hazard-list-container.visible { opacity: 1; visibility: visible; }
        .hazard-list { list-style: none; color: white; font-size: 14px; max-height: 100px; overflow-y: auto; padding: 0; }
        .hazard-list li { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 8px; }
        .hazard-list li:last-child { border-bottom: none; }

        .modal-backdrop { justify-content: center; align-items: center; }
        .modal-content { background: #2e2e48; border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; width: 100%; max-width: 350px; text-align: center; color: white; animation: modalFadeIn 0.3s ease-out; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        .checklist-progress-bar { width: 100%; max-width: 600px; height: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; margin-bottom: 20px; overflow: hidden; }
        #checklistProgress { width: 0%; height: 100%; background: #a0e7e5; border-radius: 5px; transition: width 0.5s ease; }
        .checklist { width: 100%; max-width: 600px; list-style: none; }
        .checklist-category { font-size: 18px; font-weight: 700; margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; }
        .checklist li { background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 10px; padding: 15px; display: flex; align-items: center; cursor: pointer; }
        .checklist input[type="checkbox"] { display: none; }
        .checklist label { flex-grow: 1; position: relative; padding-left: 35px; }
        .checklist label::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; border: 2px solid #a0e7e5; border-radius: 50%; }
        .checklist input:checked + label::after { content: '✔'; position: absolute; left: 5px; top: 50%; transform: translateY(-50%); color: #a0e7e5; font-size: 14px; }
        .checklist input:checked + label { text-decoration: line-through; opacity: 0.6; }

        .badges-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px; width: 100%; max-width: 600px; }
        .badge { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; text-align: center; opacity: 0.4; transition: opacity 0.3s ease; }
        .badge.unlocked { opacity: 1; }
        .badge-icon { font-size: 40px; }
        .badge-title { font-weight: 700; margin-top: 10px; }
        
        .room-secured-badge { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(46, 46, 72, 0.8); backdrop-filter: blur(10px); z-index: 600; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; cursor: pointer; opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0.5s ease; }
        .room-secured-badge.visible { opacity: 1; visibility: visible; }
        .badge-icon { font-size: 80px; margin-bottom: 20px; animation: badgePop 0.5s ease-out forwards; }
        .badge-text { font-size: 28px; font-weight: 700; margin-bottom: 10px; animation: badgeFadeInUp 0.5s 0.2s ease-out forwards; opacity: 0; }
        .badge-subtext { font-size: 16px; opacity: 0; animation: badgeFadeInUp 0.5s 0.4s ease-out forwards; }

        @keyframes badgePop { 0% { transform: scale(0.5); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes badgeFadeInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .modal-header h3 { font-size: 18px; font-weight: 700; margin-bottom: 15px; }
        .modal-body p { font-size: 15px; line-height: 1.6; opacity: 0.9; margin-bottom: 25px; }
        .modal-footer { display: flex; flex-direction: column; gap: 10px; }
        .modal-btn { width: 100%; background: rgba(255,255,255,0.1); border: none; border-radius: 15px; padding: 14px; color: white; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; font-family: 'Nunito', sans-serif; }
        .modal-btn:hover { background: rgba(255,255,255,0.2); }
        .modal-btn.danger { background: #ff7e67; }
        .modal-btn.learn-more { background: #82aaff; }

        @media (max-width: 480px) {
            .header { flex-direction: column; gap: 10px; padding-bottom: 20px;}
            .header h1 { font-size: 20px; }
            .header p { font-size: 12px; }
            .control-btn { padding: 12px 20px; font-size: 14px; }
            .room-options { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="fullscreen-overlay" id="roomSelectionScreen">
        <div class="overlay-content">
            <h2>Select a Room</h2>
            <p>Your progress will be saved for each room.</p>
            <div class="room-options">
                <button class="room-btn" onclick="selectRoom('nursery')"><span>🧸</span>Nursery</button>
                <button class="room-btn" onclick="selectRoom('living_room')"><span>🛋️</span>Living Room</button>
                <button class="room-btn" onclick="selectRoom('kitchen')"><span>🍳</span>Kitchen</button>
                <button class="room-btn" onclick="selectRoom('bathroom')"><span>🛁</span>Bathroom</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="header">
            <div class="header-title">
                <h1>🧸 Nursery Scout</h1>
                <p id="roomNameDisplay">Nursery</p>
            </div>
            <div class="safety-score-container">
                <div class="safety-score-label">Safety Score</div>
                <div class="safety-score" id="safetyScore">100</div>
            </div>
        </div>

        <div class="camera-container" id="captureArea">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <svg class="camera-overlay" id="overlay"></svg>
            <div class="camera-error" id="cameraError" style="display: none;"></div>
        </div>

        <div class="status-indicator" id="statusIndicator">Ready</div>
        <div class="tip-banner" id="tipBanner" style="display: none;"></div>
        
        <div class="hazard-list-container" id="hazardListContainer">
            <ul class="hazard-list" id="hazardList"></ul>
        </div>

        <div class="controls">
            <button class="control-btn" id="changeRoomBtn" onclick="showRoomSelection()">Change Room</button>
            <button class="control-btn" id="scanBtn" onclick="toggleScanning()">Start Scan</button>
            <button class="control-btn danger" onclick="clearAll()">Clear</button>
            <button class="control-btn secondary" id="saveReportBtn" onclick="saveReport()" style="display: none;">Save Report</button>
            <button class="control-btn secondary" id="checklistBtn" onclick="toggleChecklist(true)">Checklist</button>
            <button class="control-btn secondary" id="badgesBtn" onclick="toggleBadges(true)" style="display: none;">Badges</button>
        </div>
    </div>

    <!-- Modals and Overlays -->
    <div class="modal-backdrop" id="hazardModalBackdrop" style="display:none;">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modalHazardName"></h3></div>
            <div class="modal-body"><p id="modalHazardTip"></p></div>
            <div class="modal-footer">
                <button class="modal-btn learn-more" id="modalLearnMoreBtn">Find Solutions</button>
                <button class="modal-btn" id="modalKeepBtn">Keep</button>
                <button class="modal-btn danger" id="modalDismissBtn">Dismiss</button>
            </div>
        </div>
    </div>
    
    <div class="room-secured-badge" id="roomSecuredBadge">
        <div class="badge-icon">✅</div>
        <div class="badge-text">Room Secured!</div>
        <p class="badge-subtext">Great job! Tap to continue.</p>
    </div>

    <div class="fullscreen-overlay" id="checklistScreen" style="display:none;">
        <div class="overlay-header">
            <h2>Baby Proofing Checklist</h2>
            <button class="close-btn" onclick="toggleChecklist(false)">✖</button>
        </div>
        <div class="checklist-progress-bar"><div id="checklistProgress"></div></div>
        <ul class="checklist" id="checklist"></ul>
    </div>

    <div class="fullscreen-overlay" id="badgesScreen" style="display:none;">
        <div class="overlay-header">
            <h2>My Badges</h2>
            <button class="close-btn" onclick="toggleBadges(false)">✖</button>
        </div>
        <div class="badges-grid" id="badgesGrid"></div>
    </div>
    
    <div class="toast-notification" id="toastNotification"></div>


    <script>
        // --- App State ---
        const state = {
            isScanning: false,
            isAnalyzing: false,
            lastScanSuccessful: false,
            detectedHazards: [],
            hazardIdCounter: 0,
            videoTrack: null,
            isFlashOn: false,
            checklist: {},
            badges: {},
            points: 0,
            streak: 0,
            currentRoom: 'nursery',
        };

        // --- DOM Elements ---
        let ui;

        // --- Constants ---
        const API_SCAN_INTERVAL = 5000; // Slower for better AI
        const HAZARD_TYPES = {
            'outlet':   { name: 'Electrical Outlet', color: '#ff7e67', points: 15 },
            'sharp':    { name: 'Sharp Corner',      color: '#f9d423', points: 10 },
            'small':    { name: 'Choking Hazard',    color: '#ff7e67', points: 15 },
            'chemical': { name: 'Chemical/Cleaner',  color: '#ff7e67', points: 20 },
            'cord':     { name: 'Loose Cord',        color: '#f9d423', points: 10 },
            'unstable': { name: 'Unstable Object',   color: '#82aaff', points: 5  }
        };
        // 🔑 Add your Gemini API key here
        const GEMINI_API_KEY = "YOUR_API_KEY_HERE"; // <-- replace with your real key


        // --- App Initialization ---
        window.addEventListener('load', () => {
            ui = {
                video: document.getElementById('video'),
                canvas: document.getElementById('canvas'),
                ctx: document.getElementById('canvas').getContext('2d'),
                overlay: document.getElementById('overlay'),
                appContainer: document.getElementById('appContainer'),
                scanBtn: document.getElementById('scanBtn'),
                flashBtn: document.getElementById('flashBtn'),
                statusIndicator: document.getElementById('statusIndicator'),
                cameraError: document.getElementById('cameraError'),
                saveReportBtn: document.getElementById('saveReportBtn'),
                checklistBtn: document.getElementById('checklistBtn'),
                badgesBtn: document.getElementById('badgesBtn'),
                hazardListContainer: document.getElementById('hazardListContainer'),
                hazardList: document.getElementById('hazardList'),
                roomSecuredBadge: document.getElementById('roomSecuredBadge'),
                safetyScore: document.getElementById('safetyScore'),
                checklistScreen: document.getElementById('checklistScreen'),
                checklist: document.getElementById('checklist'),
                checklistProgress: document.getElementById('checklistProgress'),
                badgesScreen: document.getElementById('badgesScreen'),
                badgesGrid: document.getElementById('badgesGrid'),
                toastNotification: document.getElementById('toastNotification'),
                roomSelectionScreen: document.getElementById('roomSelectionScreen'),
                roomNameDisplay: document.getElementById('roomNameDisplay'),
                tipBanner: document.getElementById('tipBanner'),
            };

            ui.roomSecuredBadge.addEventListener('click', () => ui.roomSecuredBadge.classList.remove('visible'));
            
            if (window.location.protocol !== 'https:') {
                showError('<h3>🔒 Secure Connection Required</h3><p>To use your camera, this page must be loaded over a secure (HTTPS) connection.</p>');
                ui.roomSelectionScreen.style.display = 'none';
            }
        });
        
        // --- Room & State Management ---
        function selectRoom(room) {
            state.currentRoom = room;
            ui.roomNameDisplay.textContent = room.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            ui.roomSelectionScreen.style.display = 'none';
            ui.appContainer.style.display = 'flex';
            loadState();
            initCamera();
        }

        function showRoomSelection() {
            ui.roomSelectionScreen.style.display = 'flex';
            ui.appContainer.style.display = 'none';
            if (state.videoTrack) {
                state.videoTrack.stop();
            }
        }

        // --- Camera Logic ---
        async function initCamera() {
            try {
                showStatus('📱 Requesting camera permission...');
                const constraints = { video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                ui.video.srcObject = stream;
                state.videoTrack = stream.getVideoTracks()[0];
                
                await ui.video.play();
                
                await new Promise(resolve => {
                    ui.video.onloadedmetadata = () => {
                        ui.canvas.width = ui.video.videoWidth;
                        ui.canvas.height = ui.video.videoHeight;
                        resolve();
                    };
                });
                
                ui.cameraError.style.display = 'none';
                ui.scanBtn.style.display = 'inline-block';
                
                const capabilities = state.videoTrack.getCapabilities();
                if (capabilities.torch) {
                    ui.flashBtn.style.display = 'inline-block';
                }
                
                showStatus('✅ Camera ready');
                showTipOfTheDay();

            } catch (error) {
                handleCameraError(error);
            }
        }

        // --- Core Scanning & AI Logic ---
        function toggleScanning() {
            state.isScanning = !state.isScanning;
            if (state.isScanning) {
                ui.scanBtn.textContent = 'Stop Scan';
                ui.scanBtn.classList.add('active');
                ui.saveReportBtn.style.display = 'none';
                showStatus('🔍 Starting AI scan...');
                clearAll();
                scanLoop();
            } else {
                ui.scanBtn.textContent = 'Start Scan';
                ui.scanBtn.classList.remove('active');
                if (state.scanLoopTimeout) clearTimeout(state.scanLoopTimeout);
                showStatus('Scan paused.');
                ui.saveReportBtn.style.display = 'inline-block';
                
                if (state.lastScanSuccessful && state.detectedHazards.length === 0) {
                    showRoomSecured();
                }
            }
        }

        async function scanLoop() {
            if (!state.isScanning || state.isAnalyzing) return;

            try {
                state.isAnalyzing = true;
                state.lastScanSuccessful = false;
                ui.scanBtn.disabled = true;
                showStatus('🧠 Analyzing frame...');

                const hazards = await analyzeFrameWithAI();

                clearOverlays();
                if (hazards && hazards.length > 0) {
                    hazards.forEach(h => addHazard(h));
                    showStatus(`⚠️ Found ${hazards.length} hazard(s)!`);
                } else {
                    showStatus('✅ All clear! Scanning...');
                }
                updateHazardList();
                calculateSafetyScore();
                
                unlockBadge('firstScan');
                ui.badgesBtn.style.display = 'inline-block';
                state.lastScanSuccessful = true;

            } catch (error) {
                console.error("AI Analysis Error:", error);
                showStatus('❌ AI analysis failed. Retrying...');
            } finally {
                state.isAnalyzing = false;
                ui.scanBtn.disabled = false;
                if (state.isScanning) {
                    state.scanLoopTimeout = setTimeout(scanLoop, API_SCAN_INTERVAL);
                }
            }
        }
        
        async function analyzeFrameWithAI() {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_API_KEY_HERE") {
                console.error("❌ No Gemini API key set!");
                showError('<h3>🔑 API Key Missing</h3><p>Please add your Google AI API key to the code to enable scanning.</p>');
                toggleScanning();
                return [];
            }
            ui.ctx.drawImage(ui.video, 0, 0, ui.canvas.width, ui.canvas.height);
            const base64ImageData = ui.canvas.toDataURL('image/jpeg', 0.4).split(',')[1];
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;

            const prompt = `You are an expert baby-proofing consultant with 20 years of experience. Your task is to analyze this room from the perspective of a curious and mobile toddler. Your highest priority is to identify immediate, actionable dangers. First, find things that are out of place and dangerous (e.g., a pill on the floor). Second, find environmental hazards (e.g., sharp corners). For each hazard you find, you MUST provide its type, a confidence score (0.0 to 1.0), and a precise polygon outlining the object's exact shape. Return ONLY a JSON array of these objects. Focus ONLY on these types: 'outlet', 'sharp', 'small', 'chemical', 'cord', 'unstable'.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "type": { "type": "STRING", "enum": Object.keys(HAZARD_TYPES) }, "confidence": { "type": "NUMBER" }, "polygon": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "x": { "type": "NUMBER" }, "y": { "type": "NUMBER" } }, "required": ["x", "y"] } } }, "required": ["type", "confidence", "polygon"] } }
                }
            };

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

            if (!response.ok) {
                const errorBody = await response.json();
                if (errorBody.error && errorBody.error.message.includes("API key not valid")) {
                     showError('<h3>🔑 Invalid API Key</h3><p>Please check your Google AI API key and try again.</p>');
                     toggleScanning();
                }
                throw new Error(`API request failed: ${response.status}`);
            }
            const result = await response.json();
            
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                return JSON.parse(result.candidates[0].content.parts[0].text);
            }
            return [];
        }

        // --- UI and Hazard Management ---
        function addHazard(hazardData) {
            const hazardId = ++state.hazardIdCounter;
            const hazardInfo = HAZARD_TYPES[hazardData.type] || { name: 'Unknown', color: '#ffffff', points: 5 };
            const newHazard = { id: hazardId, ...hazardData, ...hazardInfo };
            state.detectedHazards.push(newHazard);
            
            if (hazardData.polygon) {
                addHazardOverlay(newHazard);
            }
        }

        function addHazardOverlay(hazard) {
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.id = `hazard-${hazard.id}`;
            polygon.classList.add('hazard-polygon');
            
            const color = hazard.confidence < 0.7 ? '#f9d423' : hazard.color; // Yellow for low confidence
            polygon.style.stroke = color;
            polygon.style.color = color;
            
            const videoWidth = ui.video.clientWidth;
            const videoHeight = ui.video.clientHeight;

            const points = hazard.polygon.map(p => `${p.x * videoWidth},${p.y * videoHeight}`).join(' ');
            
            polygon.setAttribute('points', points);
            polygon.onclick = () => showHazardAlert(hazard);
            ui.overlay.appendChild(polygon);
        }
        
        function updateHazardList() {
            ui.hazardList.innerHTML = '';
            if (state.detectedHazards.length > 0) {
                state.detectedHazards.forEach(h => {
                    const li = document.createElement('li');
                    li.textContent = `🧸 ${h.name}`;
                    li.style.borderLeft = `4px solid ${h.color || '#fff'}`;
                    ui.hazardList.appendChild(li);
                });
                ui.hazardListContainer.classList.add('visible');
            } else {
                ui.hazardListContainer.classList.remove('visible');
            }
        }
        
        function calculateSafetyScore() {
            let score = 100;
            state.detectedHazards.forEach(h => { score -= h.points; });
            ui.safetyScore.textContent = Math.max(0, score);
        }

        function removeHazard(hazardId) {
            const hazardElement = document.getElementById(`hazard-${hazardId}`);
            if (hazardElement) hazardElement.remove();
            state.detectedHazards = state.detectedHazards.filter(h => h.id !== hazardId);
            updateHazardList();
            calculateSafetyScore();
            state.points += 25;
            updatePointsDisplay();
            
            if (Object.keys(state.badges).length > 0 && !state.badges['clear10']) {
                const clearedCount = parseInt(localStorage.getItem(`nurseryScout_${state.currentRoom}_clearedCount`) || '0') + 1;
                localStorage.setItem(`nurseryScout_${state.currentRoom}_clearedCount`, clearedCount);
                if (clearedCount >= 10) {
                    unlockBadge('clear10');
                }
            }
        }

        function clearOverlays() { ui.overlay.innerHTML = ''; }
        
        function clearAll() {
            clearOverlays();
            state.detectedHazards = [];
            state.hazardIdCounter = 0;
            updateHazardList();
            calculateSafetyScore();
        }
        
        async function toggleFlash() {
            if (!state.videoTrack || !state.videoTrack.getCapabilities().torch) return;
            try {
                state.isFlashOn = !state.isFlashOn;
                await state.videoTrack.applyConstraints({ advanced: [{ torch: state.isFlashOn }] });
                ui.flashBtn.classList.toggle('active', state.isFlashOn);
                showStatus(`Flash ${state.isFlashOn ? 'On' : 'Off'}`);
            } catch (e) {
                console.error('Flash control error:', e);
                showError('<h3>🔦 Flash Error</h3><p>Could not control the flash.</p>');
            }
        }
        
        function showRoomSecured() {
            if (typeof Tone !== 'undefined') {
                const synth = new Tone.PolySynth(Tone.Synth).toDestination();
                const now = Tone.now();
                synth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n", now);
                synth.triggerAttackRelease(["E4", "G4", "C5"], "8n", now + 0.2);
            }
            ui.roomSecuredBadge.classList.add('visible');
        }
        
        // --- Report, Checklist, Badges ---
        async function saveReport() {
            showStatus('🖼️ Creating report...', 2000);
            try {
                const canvas = await html2canvas(document.getElementById('captureArea'), { useCORS: true });
                const link = document.createElement('a');
                link.download = `NurseryScout_Report_${state.currentRoom}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (e) {
                console.error('Failed to create report:', e);
                showError('<h3>❌ Report Failed</h3><p>Could not generate the report image.</p>');
            }
        }

        function toggleChecklist(show) { ui.checklistScreen.style.display = show ? 'flex' : 'none'; }
        function toggleBadges(show) { ui.badgesScreen.style.display = show ? 'flex' : 'none'; }

        // --- Utility Functions ---
        function handleCameraError(error) {
            console.error('Camera error:', error);
            let msg = `<h3>📱 Camera Error</h3><p>${error.message}</p>`;
            if (error.name === 'NotAllowedError') {
                msg = '<h3>🚫 Permission Denied</h3><p>Please enable camera access in browser settings.</p>';
            }
            showError(`${msg}<button class="control-btn" onclick="initCamera()" style="margin-top:15px;">🔄 Try Again</button>`);
        }

        function showError(htmlContent) {
            ui.cameraError.innerHTML = htmlContent;
            ui.cameraError.style.display = 'block';
        }

        function showStatus(message, duration = 3000) {
            ui.statusIndicator.textContent = message;
            ui.statusIndicator.style.display = 'block';
            ui.statusIndicator.style.opacity = '1';
            setTimeout(() => {
                ui.statusIndicator.style.opacity = '0';
                setTimeout(() => ui.statusIndicator.style.display = 'none', 300);
            }, duration);
        }

        function showToast(message) {
            ui.toastNotification.textContent = message;
            ui.toastNotification.style.display = 'block';
            ui.toastNotification.style.opacity = '1';
            setTimeout(() => {
                ui.toastNotification.style.opacity = '0';
                setTimeout(() => ui.toastNotification.style.display = 'none', 300);
            }, 4000);
        }
        
        const seasonalTips = [
            "🧸 Tip: During holidays, new decorations can become choking hazards.",
            "☀️ Tip: In summer, ensure paddling pools are always empty after use.",
            "❄️ Tip: Check that heaters are secure and cords are out of reach in winter.",
            "🎁 Tip: After birthdays, clear away small toy parts and wrapping.",
        ];

        function showTipOfTheDay() {
            const tip = seasonalTips[Math.floor(Math.random() * seasonalTips.length)];
            ui.tipBanner.textContent = tip;
            ui.tipBanner.style.display = 'block';
            ui.tipBanner.onclick = () => ui.tipBanner.style.display = 'none';
        }


        function showHazardAlert(hazard) {
            const modal = document.getElementById('hazardModalBackdrop');
            document.getElementById('modalHazardName').textContent = `🧸 ${hazard.name}`;
            const tips = {
                outlet: 'Install safety plugs or sliding outlet covers immediately.',
                sharp: 'Add corner guards or edge bumpers to prevent head injuries.',
                small: 'Remove small objects. Use the toilet paper tube test for size.',
                chemical: 'Store all chemicals in locked cabinets, high up and out of reach.',
                cord: 'Secure cords with covers or keep them completely out of reach.',
                unstable: 'Anchor tall furniture and TVs to the wall to prevent tip-overs.'
            };
            document.getElementById('modalHazardTip').textContent = `Safety Tip: ${tips[hazard.type] || 'Secure this item.'}`;
            
            document.getElementById('modalLearnMoreBtn').onclick = () => {
                const query = encodeURIComponent(`best ${hazard.name} safety products`);
                window.open(`https://www.google.com/search?q=${query}`, '_blank');
            };

            document.getElementById('modalDismissBtn').onclick = () => {
                removeHazard(hazard.id);
                modal.style.display = 'none';
            };
            document.getElementById('modalKeepBtn').onclick = () => {
                modal.style.display = 'none';
            };
            
            modal.style.display = 'flex';
        }
        
        // --- Checklist Logic ---
        const checklistItems = [
            { category: 'General Safety', items: [
                { id: 'smokeAlarms', text: 'Test smoke and CO alarms' },
                { id: 'firstAid', text: 'Have a well-stocked first-aid kit' },
                { id: 'emergencyNumbers', text: 'Post emergency numbers' },
                { id: 'windows', text: 'Install window guards and stops' },
            ]},
            { category: 'Furniture & Fixtures', items: [
                { id: 'anchorFurniture', text: 'Anchor heavy furniture to walls' },
                { id: 'coverCorners', text: 'Cover sharp corners and edges' },
                { id: 'secureCords', text: 'Secure blind and curtain cords' },
            ]},
            { category: 'Electrical & Appliances', items: [
                { id: 'coverOutlets', text: 'Cover all unused electrical outlets' },
                { id: 'hideCords', text: 'Hide electrical cords behind furniture' },
                { id: 'waterHeater', text: 'Set water heater to 120°F (49°C)' },
            ]},
        ];

        function renderChecklist() {
            ui.checklist.innerHTML = '';
            checklistItems.forEach(category => {
                const categoryTitle = document.createElement('h3');
                categoryTitle.className = 'checklist-category';
                categoryTitle.textContent = category.category;
                ui.checklist.appendChild(categoryTitle);
                category.items.forEach(item => {
                    const li = document.createElement('li');
                    li.dataset.id = item.id;
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = item.id;
                    const label = document.createElement('label');
                    label.htmlFor = item.id;
                    label.textContent = item.text;
                    li.appendChild(input);
                    li.appendChild(label);
                    ui.checklist.appendChild(li);
                });
            });
            ui.checklist.addEventListener('click', handleChecklistItemClick);
        }
        
        function handleChecklistItemClick(e) {
            if (e.target.tagName === 'LABEL') {
                const checkbox = document.getElementById(e.target.htmlFor);
                checkbox.checked = !checkbox.checked;
                state.checklist[checkbox.id] = checkbox.checked;
                if (checkbox.checked) {
                    state.points += 10;
                    updatePointsDisplay();
                }
                saveState();
                updateChecklistProgress();
            }
        }
        
        function updateChecklistProgress() {
            const allItems = checklistItems.flatMap(c => c.items);
            const checkedItems = Object.values(state.checklist).filter(Boolean).length;
            const percentage = (checkedItems / allItems.length) * 100;
            ui.checklistProgress.style.width = `${percentage}%`;
            if (percentage === 100) {
                unlockBadge('checklistComplete');
            }
        }

        // --- Badge Logic ---
        const badges = {
            firstScan: { icon: 'SCAN', title: 'First Scan' },
            clear10: { icon: 'TARGET', title: 'Hazard Hunter' },
            checklistComplete: { icon: 'CHECK', title: 'Planner Pro' },
            streak3: { icon: 'STREAK', title: '3-Day Streak' },
            superScout: { icon: 'STAR', title: 'Super Scout' },
        };

        function renderBadges() {
            ui.badgesGrid.innerHTML = '';
            for (const id in badges) {
                const badge = badges[id];
                const isUnlocked = state.badges[id];
                const div = document.createElement('div');
                div.className = `badge ${isUnlocked ? 'unlocked' : ''}`;
                div.innerHTML = `<div class="badge-icon">${badge.icon}</div><div class="badge-title">${badge.title}</div>`;
                ui.badgesGrid.appendChild(div);
            }
        }

        function unlockBadge(id) {
            if (!state.badges[id]) {
                state.badges[id] = true;
                saveState();
                renderBadges();
                showToast(`🏆 Badge Unlocked: ${badges[id].title}!`);
            }
        }

        // --- State Management (localStorage) ---
        function saveState() {
            const roomState = {
                checklist: state.checklist,
                clearedCount: parseInt(localStorage.getItem(`nurseryScout_${state.currentRoom}_clearedCount`) || '0'),
                score: ui.safetyScore.textContent,
            };
            localStorage.setItem(`nurseryScout_${state.currentRoom}`, JSON.stringify(roomState));
            
            const globalState = {
                badges: state.badges,
                points: state.points,
                streak: state.streak,
                lastVisit: new Date().toISOString().split('T')[0], // YYYY-MM-DD
            };
            localStorage.setItem('nurseryScout_global', JSON.stringify(globalState));
        }

        function loadState() {
            const roomState = JSON.parse(localStorage.getItem(`nurseryScout_${state.currentRoom}`) || '{}');
            state.checklist = roomState.checklist || {};
            
            const globalState = JSON.parse(localStorage.getItem('nurseryScout_global') || '{}');
            state.badges = globalState.badges || {};
            state.points = globalState.points || 0;
            
            // Streak Logic
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            if (globalState.lastVisit === yesterday) {
                state.streak = (globalState.streak || 0) + 1;
            } else if (globalState.lastVisit !== today) {
                state.streak = 1; // Reset if not visited yesterday or today
            } else {
                state.streak = globalState.streak || 0;
            }
            if (state.streak >= 3) unlockBadge('streak3');

            saveState(); // Save updated streak/visit date
            
            // Apply loaded state
            for (const id in state.checklist) {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = state.checklist[id];
            }
            updateChecklistProgress();
            updatePointsDisplay();
            
            if (Object.keys(state.badges).length > 0) {
                ui.badgesBtn.style.display = 'inline-block';
            }
        }
        
        function updatePointsDisplay() {
            // In a real app, you'd display this. For now, we just track it.
            console.log("Total Points:", state.points);
        }

    </script>
</body>
</html>
